import { type NextPage } from "next";
import Head from "next/head";
import { useEffect, useState } from "react";
import { io } from "socket.io-client";
import Header from "../components/Header";
import styles from "../styles/Home.module.css";
import BubbleDetail from "../components/BubbleDetail";
import { io } from "socket.io-client";
import { useEffect, useState } from "react";
import { text } from "stream/consumers";

type Message = {
	username: string;
	avatar: string;
	roles?: string[];
	channel: {
		name: string;
		description: string;
	};
	text: string;
	timestamp: string;
};

const Home: NextPage = () => {
	const [messages, setMessages] = useState<Message[]>([]);

	useEffect(() => {
		const socket = io("http://localhost:3001");

		socket.on("connect", () => {
			console.info("Connected");
		});

		socket.on("disconnect", () => {
			console.info("Disconnected");
		});

		socket.on("message", (message: Message) => {
			setMessages(prevMessages => [...new Set([...prevMessages, message])]);
		});

		return () => {
			socket.disconnect();
		};
	}, []);

	return (
		<>
			<Head>
				<title>Code Crusaders</title>
				<meta name="description" content="Generated by create-t3-app" />
				<link rel="favicon icon" href="/favicon.svg" type="image/svg+xml" />
			</Head>
			<Header />
			<main className={styles.background}>
				{messages.map((message, i) => (
					<BubbleDetail name={message.username} avatar={message.avatar} text={message.text}/>
				))}
			</main>
		</>
	);
};

export default Home;
